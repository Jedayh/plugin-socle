<?php
class SubscriptionMeta {
	private $config = '{"title":"subcription","prefix":"subscription_","domain":"ats35_","class_name":"SubscriptionMeta","context":"normal","priority":"default","cpt":"souscription","fields":[{"type":"text","label":"vousetes","id":"subscription_fd_vousetes"},{"type":"text","label":"typesoc","id":"subscription_fd_typesoc"},{"type":"text","label":"typesoc_crea_statuts","id":"subscription_fd_typesoc_crea_statuts"},{"type":"text","label":"siret","id":"subscription_fd_siret"},{"type":"text","label":"typesoc_dem_statuts","id":"subscription_fd_typesoc_dem_statuts"},{"type":"text","label":"typesoc_dem_kbis","id":"subscription_fd_typesoc_dem_kbis"},{"type":"text","label":"etaDomic","id":"subscription_fd_etadomic"},{"type":"text","label":"nomjuridique","id":"subscription_fd_nomjuridique"},{"type":"text","label":"nomComCheck","id":"subscription_fd_nomcomcheck"},{"type":"text","label":"nomCom","id":"subscription_fd_nomcom"},{"type":"text","label":"statutJuri","id":"subscription_fd_statutjuri"},{"type":"text","label":"secteur","id":"subscription_fd_secteur"},{"type":"text","label":"descactivi","id":"subscription_fd_descactivi"},{"type":"text","label":"capital","id":"subscription_fd_capital"},{"type":"text","label":"clienteleparticulier","id":"subscription_fd_clienteleparticulier"},{"type":"text","label":"clienteleentreprises","id":"subscription_fd_clienteleentreprises"},{"type":"text","label":"repres","id":"subscription_fd_repres"},{"type":"text","label":"moralinraison","id":"subscription_fd_moralinraison"},{"type":"text","label":"moralinnom","id":"subscription_fd_moralinnom"},{"type":"text","label":"moralinrcs","id":"subscription_fd_moralinrcs"},{"type":"text","label":"moralinactivite","id":"subscription_fd_moralinactivite"},{"type":"text","label":"moralinemail","id":"subscription_fd_moralinemail"},{"type":"text","label":"moralinadresse","id":"subscription_fd_moralinadresse"},{"type":"text","label":"moralinpostal","id":"subscription_fd_moralinpostal"},{"type":"text","label":"moralinville","id":"subscription_fd_moralinville"},{"type":"text","label":"moralinphone","id":"subscription_fd_moralinphone"},{"type":"text","label":"moralinpart","id":"subscription_fd_moralinpart"},{"type":"text","label":"moralinpiece_kbis","id":"subscription_fd_moralinpiece_kbis"},{"type":"text","label":"moralinpiece_statut","id":"subscription_fd_moralinpiece_statut"},{"type":"text","label":"moralinpiece_pi1recto","id":"subscription_fd_moralinpiece_pi1recto"},{"type":"text","label":"moralinpiece_pi1verso","id":"subscription_fd_moralinpiece_pi1verso"},{"type":"text","label":"moralinpiece_pi2recto","id":"subscription_fd_moralinpiece_pi2recto"},{"type":"text","label":"moralinpiece_pi2verso","id":"subscription_fd_moralinpiece_pi2verso"},{"type":"text","label":"moralinpiece_facture","id":"subscription_fd_moralinpiece_facture"},{"type":"text","label":"physinnom","id":"subscription_fd_physinnom"},{"type":"text","label":"physinprenom","id":"subscription_fd_physinprenom"},{"type":"text","label":"physinfonction","id":"subscription_fd_physinfonction"},{"type":"text","label":"physinemail","id":"subscription_fd_physinemail"},{"type":"text","label":"physinaddr","id":"subscription_fd_physinaddr"},{"type":"text","label":"physinpostal","id":"subscription_fd_physinpostal"},{"type":"text","label":"physinville","id":"subscription_fd_physinville"},{"type":"text","label":"physinville","id":"subscription_fd_physinville"},{"type":"text","label":"physinpart","id":"subscription_fd_physinpart"},{"type":"text","label":"physinpiece_pi1recto","id":"subscription_fd_physinpiece_pi1recto"},{"type":"text","label":"physinpiece_pi1verso","id":"subscription_fd_physinpiece_pi1verso"},{"type":"text","label":"physinpiece_pi2recto","id":"subscription_fd_physinpiece_pi2recto"},{"type":"text","label":"physinpiece_pi2verso","id":"subscription_fd_physinpiece_pi2verso"},{"type":"text","label":"physinpiece_facture","id":"subscription_fd_physinpiece_facture"},{"type":"text","label":"physassocnom","id":"subscription_fd_physassocnom"},{"type":"text","label":"physassocprenom","id":"subscription_fd_physassocprenom"},{"type":"text","label":"physassocfonction","id":"subscription_fd_physassocfonction"},{"type":"text","label":"physassocmobile","id":"subscription_fd_physassocmobile"},{"type":"text","label":"physassocphone","id":"subscription_fd_physassocphone"},{"type":"text","label":"physassocemail","id":"subscription_fd_physassocemail"},{"type":"text","label":"physassocadresse","id":"subscription_fd_physassocadresse"},{"type":"text","label":"physassocpostal","id":"subscription_fd_physassocpostal"},{"type":"text","label":"physassocville","id":"subscription_fd_physassocville"},{"type":"text","label":"physassocpart","id":"subscription_fd_physassocpart"},{"type":"text","label":"physassocpiece_pi1recto","id":"subscription_fd_physassocpiece_pi1recto"},{"type":"text","label":"physassocpiece_pi1verso","id":"subscription_fd_physassocpiece_pi1verso"},{"type":"text","label":"physassocpiece_pi2recto","id":"subscription_fd_physassocpiece_pi2recto"},{"type":"text","label":"physassocpiece_pi2verso","id":"subscription_fd_physassocpiece_pi2verso"},{"type":"text","label":"physassocpiece_facture","id":"subscription_fd_physassocpiece_facture"},{"type":"text","label":"moralassocnom","id":"subscription_fd_moralassocnom"},{"type":"text","label":"moralassocactivite","id":"subscription_fd_moralassocactivite"},{"type":"text","label":"moralassocemail","id":"subscription_fd_moralassocemail"},{"type":"text","label":"moralassocadresse","id":"subscription_fd_moralassocadresse"},{"type":"text","label":"moralassocpostal","id":"subscription_fd_moralassocpostal"},{"type":"text","label":"moralassocville","id":"subscription_fd_moralassocville"},{"type":"text","label":"moralassocphone","id":"subscription_fd_moralassocphone"},{"type":"text","label":"moralassocpart","id":"subscription_fd_moralassocpart"},{"type":"text","label":"moralassocpiece_pi1recto","id":"subscription_fd_moralassocpiece_pi1recto"},{"type":"text","label":"moralassocpiece_pi1verso","id":"subscription_fd_moralassocpiece_pi1verso"},{"type":"text","label":"moralassocpiece_pi2recto","id":"subscription_fd_moralassocpiece_pi2recto"},{"type":"text","label":"moralassocpiece_pi2verso","id":"subscription_fd_moralassocpiece_pi2verso"},{"type":"text","label":"moralassocpiece_facture","id":"subscription_fd_moralassocpiece_facture"},{"type":"text","label":"attestation_nom","id":"subscription_fd_attestation_nom"},{"type":"text","label":"attestation_demeurant","id":"subscription_fd_attestation_demeurant"},{"type":"text","label":"attestation_qualite","id":"subscription_fd_attestation_qualite"},{"type":"text","label":"attestation_societe","id":"subscription_fd_attestation_societe"},{"type":"text","label":"attestation_compta","id":"subscription_fd_attestation_compta"},{"type":"text","label":"attestation_factures","id":"subscription_fd_attestation_factures"},{"type":"text","label":"attestation_societe2","id":"subscription_fd_attestation_societe2"},{"type":"text","label":"fd_reexpedition","id":"subscription_fd_reexpedition"},{"type":"text","label":"fd_reexpedition_adresse","id":"subscription_fd_reexpedition_adresse"},{"type":"text","label":"reexpedition.semaine","id":"subscription_fd_reexpedition_semaine"},{"type":"text","label":"notificationSMS","id":"subscription_fd_notificationsms"},{"type":"text","label":"notificationMail","id":"subscription_fd_notificationmail"},{"type":"text","label":"scanCourrier","id":"subscription_fd_scancourrier"},{"type":"text","label":"cgu","id":"subscription_fd_cgu"},{"type":"text","label":"attestation_accounting_legal_documents","id":"subscription_fd_attestation_accounting_legal_documents"},{"type":"text","label":"doc","id":"subscription_doc_link"},{"type":"text","label":"depot_garant","id":"subscription_depot_garant"},{"type":"text","label":"depot_quant","id":"subscription_depot_quant"},{"type":"text","label":"dom_tarif","id":"subscription_dom_tarif"},{"type":"text","label":"dom_quant","id":"subscription_dom_quant"},{"type":"text","label":"dom_total_ht","id":"subscription_dom_total_ht"},{"type":"text","label":"dom_total_ttc","id":"subscription_dom_total_ttc"},{"type":"text","label":"sms_tarif","id":"subscription_sms_tarif"},{"type":"text","label":"sms_quant","id":"subscription_sms_quant"},{"type":"text","label":"sms_ht","id":"subscription_sms_ht"},{"type":"text","label":"sms_ttc","id":"subscription_sms_ttc"},{"type":"text","label":"mail_tarif","id":"subscription_mail_tarif"},{"type":"text","label":"mail_quant","id":"subscription_mail_quant"},{"type":"text","label":"mail_ht","id":"subscription_mail_ht"},{"type":"text","label":"mail_ttc","id":"subscription_mail_ttc"},{"type":"text","label":"scan_tarif","id":"subscription_scan_tarif"},{"type":"text","label":"scan_quant","id":"subscription_scan_quant"},{"type":"text","label":"scan_ht","id":"subscription_scan_ht"},{"type":"text","label":"scan_ttc","id":"subscription_scan_ttc"},{"type":"text","label":"total_all","id":"subscription_total_all"},{"type":"text","label":"status_payement","id":"subscription_status_payement"},{"type":"text","label":"date_heure_transaction","id":"subscription_date_heure_transaction"},{"type":"text","label":"number_transaction","id":"subscription_number_transaction"},{"type":"text","label":"motant_transaction","id":"subscription_motant_transaction"},{"type":"text","label":"autorisation_transaction","id":"subscription_autorisation_transaction"},{"type":"text","label":"paylinetoken","id":"subscription_paylinetoken"},{"type":"text","label":"code","id":"subscription_code"},{"type":"text","label":"fd_courrierATS35","id":"subscription_fd_courrierATS35"}]}';

	public function __construct() {
		$this->config = json_decode( $this->config, true );
		$this->process_cpts();
		add_action( 'add_meta_boxes', [ $this, 'add_meta_boxes' ] );
		add_action( 'save_post', [ $this, 'save_post' ] );
	}

	public function process_cpts() {
		if ( !empty( $this->config['cpt'] ) ) {
			if ( empty( $this->config['post-type'] ) ) {
				$this->config['post-type'] = [];
			}
			$parts = explode( ',', $this->config['cpt'] );
			$parts = array_map( 'trim', $parts );
			$this->config['post-type'] = array_merge( $this->config['post-type'], $parts );
		}
	}

	public function add_meta_boxes() {
		foreach ( $this->config['post-type'] as $screen ) {
			add_meta_box(
				sanitize_title( $this->config['title'] ),
				$this->config['title'],
				[ $this, 'add_meta_box_callback' ],
				$screen,
				$this->config['context'],
				$this->config['priority']
			);
		}
	}

	public function save_post( $post_id ) {
		foreach ( $this->config['fields'] as $field ) {
			switch ( $field['type'] ) {
				default:
					if ( isset( $_POST[ $field['id'] ] ) ) {
						$sanitized = sanitize_text_field( $_POST[ $field['id'] ] );
						update_post_meta( $post_id, $field['id'], $sanitized );
					}
			}
		}
	}

	public function add_meta_box_callback() {
		$this->fields_table();
	}

	private function fields_table() {
		?><table class="form-table" role="presentation">
			<tbody><?php
				foreach ( $this->config['fields'] as $field ) {
					?><tr>
						<th scope="row"><?php $this->label( $field ); ?></th>
						<td><?php $this->field( $field ); ?></td>
					</tr><?php
				}
			?></tbody>
		</table><?php
	}

	private function label( $field ) {
		switch ( $field['type'] ) {
			default:
				printf(
					'<label class="" for="%s">%s</label>',
					$field['id'], $field['label']
				);
		}
	}

	private function field( $field ) {
		switch ( $field['type'] ) {
			default:
				$this->input( $field );
		}
	}

	private function input( $field ) {
		printf(
			'<input class="regular-text %s" id="%s" name="%s" %s type="%s" value="%s">',
			isset( $field['class'] ) ? $field['class'] : '',
			$field['id'], $field['id'],
			isset( $field['pattern'] ) ? "pattern='{$field['pattern']}'" : '',
			$field['type'],
			$this->value( $field )
		);
	}

	private function value( $field ) {
		global $post;
		if ( metadata_exists( 'post', $post->ID, $field['id'] ) ) {
			$value = get_post_meta( $post->ID, $field['id'], true );
		} else if ( isset( $field['default'] ) ) {
			$value = $field['default'];
		} else {
			return '';
		}
		return str_replace( '\u0027', "'", $value );
	}

}
new SubscriptionMeta;